{% extends 'base.html' %}

{% block title %}POS Terminal{% endblock %}

{% block styles %}
<style>
    .pos-container {
        height: calc(100vh - 100px);
        overflow: hidden;
    }
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        padding: 10px;
    }
    .product-card {
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }
    .product-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .product-card.out-of-stock {
        opacity: 0.5;
        pointer-events: none;
    }
    .cart-container {
        height: calc(100vh - 150px);
        display: flex;
        flex-direction: column;
    }
    .cart-items {
        flex-grow: 1;
        overflow-y: auto;
        max-height: calc(100vh - 350px);
    }
    .cart-summary {
        border-top: 1px solid #dee2e6;
        padding-top: 1rem;
    }
    .category-pills {
        overflow-x: auto;
        white-space: nowrap;
        padding: 10px 0;
    }
    .category-pills .nav-link {
        border-radius: 20px;
        padding: 5px 15px;
        margin-right: 5px;
    }
    .quantity-control {
        width: 80px;
    }
    .product-image {
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
    }
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .product-card {
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .product-card.out-of-stock {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .cart-items {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .cart-summary {
        position: sticky;
        bottom: 0;
        background-color: white;
        z-index: 100;
        border-top: 1px solid rgba(0,0,0,.125);
    }
    
    .payment-method {
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .payment-method:hover, .payment-method.active {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    /* Make sure the checkout button is always visible */
    .card-footer {
        position: sticky;
        bottom: 0;
        background-color: white;
        z-index: 100;
        border-top: 1px solid rgba(0,0,0,.125);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid pos-container">
    <div class="row mb-2">
        <div class="col">
            <h2>POS Terminal</h2>
            <p class="text-muted">Session: {{ session.name }}</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('pos.index') }}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left"></i> Dashboard
            </a>
            <a href="{{ url_for('pos.close_session', session_id=session.id) }}" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to close this session?');">
                <i class="fas fa-power-off"></i> Close Session
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Products Section -->
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="search-products" placeholder="Search products...">
                            </div>
                        </div>
                        <div class="col-md-4 d-flex justify-content-end">
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary" id="grid-view"><i class="fas fa-th"></i></button>
                                <button class="btn btn-outline-secondary" id="list-view"><i class="fas fa-list"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Category filters -->
                    <div class="row mb-3">
                        <div class="col">
                            <div class="category-filters d-flex flex-wrap gap-2">
                                <button class="btn btn-primary category-filter active" data-category="all">All Products</button>
                                {% for category in categories %}
                                <button class="btn btn-outline-primary category-filter" data-category="{{ category.id }}">{{ category.name }}</button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-2">
                    <!-- Products Grid -->
                    <div class="product-grid" id="products-container">
                        {% for product in products %}
                        <div class="product-card card {% if product.available_quantity <= 0 %}out-of-stock{% endif %}" 
                             data-id="{{ product.id }}" 
                             data-name="{{ product.name }}" 
                             data-price="{{ product.sale_price }}"
                             data-stock="{{ product.available_quantity }}"
                             data-category="{{ product.category.id if product.category else 'none' }}"
                             data-type="{{ product.type }}">
                            <div class="card-body p-2 text-center">
                                <div class="mb-2" style="height: 80px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-box fa-2x text-muted"></i>
                                </div>
                                <h6 class="card-title mb-1">{{ product.name }}</h6>
                                <small class="text-muted">{{ product.type }}</small>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-primary fw-bold">GH₵{{ product.sale_price }}</span>
                                    <small class="text-muted">Stock: {{ product.available_quantity }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cart Section -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="mb-0">Current Order</h5>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-danger" id="clear-cart-btn">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div class="cart-container">
                        <div class="cart-items p-3" id="cart-items">
                            <div class="text-center py-5 text-muted" id="empty-cart-message">
                                <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                                <p>Your cart is empty</p>
                            </div>
                            <!-- Cart items will be added here dynamically -->
                        </div>
                        
                        <div class="cart-summary p-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span id="subtotal">GH₵0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Tax (10%):</span>
                                <span id="tax">GH₵0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Total:</span>
                                <span id="total">GH₵0.00</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-danger" id="clear-cart-btn">
                                    <i class="fas fa-trash me-2"></i> Clear
                                </button>
                                <button class="btn btn-primary" id="checkout-btn" disabled>
                                    <i class="fas fa-shopping-cart me-2"></i> Checkout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-7">
                        <h6 class="mb-3">Payment Method</h6>
                        <div class="d-flex flex-wrap gap-2 mb-4">
                            {% for method in payment_methods %}
                            <div class="card payment-method {% if loop.first %}active{% endif %}" data-method="{{ method.code }}">
                                <div class="card-body p-3 text-center">
                                    <i class="fas {% if method.is_cash %}fa-money-bill-wave{% else %}fa-credit-card{% endif %} fa-2x mb-2"></i>
                                    <h6 class="mb-0">{{ method.name }}</h6>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Cash Payment Form -->
                        <div id="cash-payment" class="payment-form">
                            <div class="mb-3">
                                <label for="amount-tendered" class="form-label">Amount Tendered (GH₵)</label>
                                <input type="number" class="form-control" id="amount-tendered" step="0.01" min="0">
                            </div>
                            <div class="mb-3">
                                <label for="change" class="form-label">Change (GH₵)</label>
                                <input type="text" class="form-control" id="change" readonly value="0.00">
                            </div>
                        </div>
                        
                        <!-- Card Payment Form -->
                        <div id="card-payment" class="payment-form d-none">
                            <div class="mb-3">
                                <label for="card-number" class="form-label">Card Number</label>
                                <input type="text" class="form-control" id="card-number" placeholder="**** **** **** ****">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="expiry-date" class="form-label">Expiry Date</label>
                                    <input type="text" class="form-control" id="expiry-date" placeholder="MM/YY">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="cvv" class="form-label">CVV</label>
                                    <input type="text" class="form-control" id="cvv" placeholder="***">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile Money Payment Form -->
                        <div id="momo-payment" class="payment-form d-none">
                            <div class="mb-3">
                                <label for="phone-number" class="form-label">Phone Number</label>
                                <input type="text" class="form-control" id="phone-number" placeholder="0XX XXX XXXX">
                            </div>
                            <div class="mb-3">
                                <label for="network" class="form-label">Network</label>
                                <select class="form-select" id="network">
                                    <option value="mtn">MTN Mobile Money</option>
                                    <option value="vodafone">Vodafone Cash</option>
                                    <option value="airteltigo">AirtelTigo Money</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Order Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Items:</span>
                                    <span id="payment-items-count">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <span id="payment-subtotal">GH₵0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Tax (10%):</span>
                                    <span id="payment-tax">GH₵0.00</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>Total:</strong>
                                    <strong id="payment-total">GH₵0.00</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="complete-payment">
                    <i class="fas fa-check me-2"></i> Complete Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Complete Modal -->
<div class="modal fade" id="transactionCompleteModal" tabindex="-1" aria-labelledby="transactionCompleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="transactionCompleteModalLabel">Transaction Complete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                <h4>Order Completed Successfully!</h4>
                <p>Order #<span id="completed-order-id"></span> has been processed.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-outline-secondary" id="view-receipt-btn">
                    <i class="fas fa-receipt me-2"></i> View Receipt
                </button>
                <button type="button" class="btn btn-primary" id="new-transaction-btn">
                    <i class="fas fa-plus me-2"></i> New Transaction
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Cart state
        let cart = [];
        let selectedPaymentMethod = 'cash';
        const currency = 'GH₵';
        
        // DOM elements
        const productsContainer = document.getElementById('products-container');
        const productSearch = document.getElementById('search-products');
        const productCards = document.querySelectorAll('.product-card');
        const cartItemsContainer = document.getElementById('cart-items');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const clearCartButton = document.getElementById('clear-cart-btn');
        const checkoutButton = document.getElementById('checkout-btn');
        const subtotalElement = document.getElementById('subtotal');
        const taxElement = document.getElementById('tax');
        const totalElement = document.getElementById('total');
        const categoryLinks = document.querySelectorAll('.category-filters .category-filter');
        
        // Payment modal elements
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        const paymentMethods = document.querySelectorAll('.payment-method');
        const paymentForms = document.querySelectorAll('.payment-form');
        const amountTendered = document.getElementById('amount-tendered');
        const changeElement = document.getElementById('change');
        const completePaymentButton = document.getElementById('complete-payment');
        const paymentItemsCount = document.getElementById('payment-items-count');
        const paymentSubtotal = document.getElementById('payment-subtotal');
        const paymentTax = document.getElementById('payment-tax');
        const paymentTotal = document.getElementById('payment-total');
        
        // Transaction complete modal elements
        const transactionCompleteModal = new bootstrap.Modal(document.getElementById('transactionCompleteModal'));
        const viewReceiptButton = document.getElementById('view-receipt-btn');
        const newTransactionButton = document.getElementById('new-transaction-btn');
        const completedOrderId = document.getElementById('completed-order-id');
        
        // Category filtering
        categoryLinks.forEach(link => {
            link.addEventListener('click', function() {
                // Remove active class from all category links
                categoryLinks.forEach(l => l.classList.remove('active'));
                // Add active class to clicked link
                this.classList.add('active');
                
                const category = this.getAttribute('data-category');
                
                // Filter products
                productCards.forEach(card => {
                    if (category === 'all' || card.getAttribute('data-category') === category) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });
        
        // Product search
        productSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            // Get active category
            const activeCategory = document.querySelector('.category-filter.active').getAttribute('data-category');
            
            productCards.forEach(card => {
                const productName = card.getAttribute('data-name').toLowerCase();
                const productCategory = card.getAttribute('data-category');
                
                // Check if product matches search term and category filter
                const matchesSearch = productName.includes(searchTerm);
                const matchesCategory = activeCategory === 'all' || productCategory === activeCategory;
                
                if (matchesSearch && matchesCategory) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
        
        // Add to cart functionality
        productCards.forEach(card => {
            card.addEventListener('click', function() {
                const productId = parseInt(this.getAttribute('data-id'));
                const productName = this.getAttribute('data-name');
                const productPrice = parseFloat(this.getAttribute('data-price'));
                const productStock = parseFloat(this.getAttribute('data-stock'));
                const productType = this.getAttribute('data-type');
                
                // Check if product is already in cart
                const existingItem = cart.find(item => item.id === productId);
                
                if (existingItem) {
                    // Check if we can add more of this product
                    if (existingItem.quantity < productStock) {
                        existingItem.quantity += 1;
                    } else {
                        alert('Cannot add more of this product. Maximum stock reached.');
                        return;
                    }
                } else {
                    // Add new item to cart
                    cart.push({
                        id: productId,
                        name: productName,
                        price: productPrice,
                        quantity: 1,
                        maxStock: productStock,
                        type: productType
                    });
                }
                
                // Update cart UI
                updateCartUI();
            });
        });
        
        // Clear cart button
        clearCartButton.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear the cart?')) {
                cart = [];
                updateCartUI();
            }
        });
        
        // Checkout button
        checkoutButton.addEventListener('click', function() {
            // Update payment modal with cart details
            paymentItemsCount.textContent = cart.reduce((total, item) => total + item.quantity, 0);
            
            const subtotal = calculateSubtotal();
            const tax = calculateTax();
            const total = subtotal + tax;
            
            paymentSubtotal.textContent = `${currency}${subtotal.toFixed(2)}`;
            paymentTax.textContent = `${currency}${tax.toFixed(2)}`;
            paymentTotal.textContent = `${currency}${total.toFixed(2)}`;
            
            // Set initial amount tendered to match total
            amountTendered.value = total.toFixed(2);
            changeElement.value = '0.00';
            
            // Show payment modal
            paymentModal.show();
        });
        
        // Payment method selection
        paymentMethods.forEach(method => {
            method.addEventListener('click', function() {
                // Remove active class from all methods
                paymentMethods.forEach(m => m.classList.remove('active'));
                
                // Add active class to clicked method
                this.classList.add('active');
                
                // Hide all payment forms
                paymentForms.forEach(form => form.classList.add('d-none'));
                
                // Show the selected payment form
                selectedPaymentMethod = this.getAttribute('data-method');
                const paymentForm = document.getElementById(`${selectedPaymentMethod}-payment`);
                if (paymentForm) {
                    paymentForm.classList.remove('d-none');
                }
            });
        });
        
        // Calculate change when amount tendered changes
        amountTendered.addEventListener('input', function() {
            const tendered = parseFloat(this.value) || 0;
            const total = calculateSubtotal() + calculateTax();
            
            if (tendered >= total) {
                changeElement.value = (tendered - total).toFixed(2);
            } else {
                changeElement.value = '0.00';
            }
        });
        
        // Complete payment button
        completePaymentButton.addEventListener('click', function() {
            // Validate payment based on method
            if (selectedPaymentMethod === 'cash') {
                const tendered = parseFloat(amountTendered.value) || 0;
                const total = calculateSubtotal() + calculateTax();
                
                if (tendered < total) {
                    alert('Amount tendered must be greater than or equal to the total amount.');
                    return;
                }
            }
            
            // Create order data
            const orderData = {
                customer_id: document.getElementById('customer-select') ? document.getElementById('customer-select').value || null : null,
                payment_method: selectedPaymentMethod,
                items: cart.map(item => ({
                    product_id: item.id,
                    quantity: parseFloat(item.quantity),
                    price: parseFloat(item.price)
                })),
                total_amount: parseFloat((calculateSubtotal() + calculateTax()).toFixed(2)),
                tax_amount: parseFloat(calculateTax().toFixed(2)),
                payment_reference: selectedPaymentMethod === 'card' ? 
                    document.getElementById('card-number').value : 
                    (selectedPaymentMethod === 'momo' ? document.getElementById('phone-number').value : '')
            };
            
            console.log('Sending order data:', orderData);
            
            // Send order to server
            fetch('/pos/api/create-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    alert('Order completed successfully!');
                    cart = [];
                    updateCartUI();
                    paymentModal.hide();
                    
                    // Show transaction complete modal
                    completedOrderId.textContent = data.order_id;
                    transactionCompleteModal.show();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while processing your order.');
            });
        });
        
        // View receipt button
        viewReceiptButton.addEventListener('click', function() {
            // Get the order ID from the completed order span
            const orderId = completedOrderId.textContent;
            if (orderId) {
                // Open receipt in a new window
                window.open(`/pos/receipt/${orderId}`, '_blank');
            } else {
                alert('Order ID not found. Cannot display receipt.');
            }
        });
        
        // New transaction button
        newTransactionButton.addEventListener('click', function() {
            transactionCompleteModal.hide();
        });
        
        // Helper function to update cart UI
        function updateCartUI() {
            if (cart.length === 0) {
                emptyCartMessage.style.display = 'block';
                cartItemsContainer.innerHTML = '';
                checkoutButton.disabled = true;
            } else {
                emptyCartMessage.style.display = 'none';
                
                // Clear cart items container
                cartItemsContainer.innerHTML = '';
                
                // Add each item to the cart UI
                cart.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'card mb-2';
                    itemElement.innerHTML = `
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">${item.name}</h6>
                                    <small class="text-muted">${item.type}</small>
                                    <small class="text-muted">${currency}${item.price.toFixed(2)} each</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-sm btn-outline-secondary decrease-quantity" data-index="${index}">-</button>
                                    <input type="number" class="form-control form-control-sm mx-1 quantity-control" value="${item.quantity}" min="1" max="${item.maxStock}" data-index="${index}">
                                    <button class="btn btn-sm btn-outline-secondary increase-quantity" data-index="${index}">+</button>
                                    <button class="btn btn-sm btn-outline-danger ms-2 remove-item" data-index="${index}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <span>Subtotal:</span>
                                <span>${currency}${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                });
                
                // Add event listeners to quantity controls
                document.querySelectorAll('.decrease-quantity').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        if (cart[index].quantity > 1) {
                            cart[index].quantity -= 1;
                            updateCartUI();
                            
                            // Update the payment modal totals if it's open
                            if (paymentModal._isShown) {
                                paymentItemsCount.textContent = cart.reduce((total, item) => total + item.quantity, 0);
                                paymentSubtotal.textContent = `${currency}${calculateSubtotal().toFixed(2)}`;
                                paymentTax.textContent = `${currency}${calculateTax().toFixed(2)}`;
                                paymentTotal.textContent = `${currency}${(calculateSubtotal() + calculateTax()).toFixed(2)}`;
                            }
                        }
                    });
                });
                
                document.querySelectorAll('.increase-quantity').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        if (cart[index].quantity < cart[index].maxStock) {
                            cart[index].quantity += 1;
                            updateCartUI();
                            
                            // Update the payment modal totals if it's open
                            if (paymentModal._isShown) {
                                paymentItemsCount.textContent = cart.reduce((total, item) => total + item.quantity, 0);
                                paymentSubtotal.textContent = `${currency}${calculateSubtotal().toFixed(2)}`;
                                paymentTax.textContent = `${currency}${calculateTax().toFixed(2)}`;
                                paymentTotal.textContent = `${currency}${(calculateSubtotal() + calculateTax()).toFixed(2)}`;
                            }
                        } else {
                            alert('Cannot add more of this product. Maximum stock reached.');
                        }
                    });
                });
                
                document.querySelectorAll('.quantity-control').forEach(input => {
                    input.addEventListener('change', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        const newQuantity = parseInt(this.value) || 1;
                        
                        if (newQuantity < 1) {
                            this.value = 1;
                            cart[index].quantity = 1;
                        } else if (newQuantity > cart[index].maxStock) {
                            this.value = cart[index].maxStock;
                            cart[index].quantity = cart[index].maxStock;
                            alert('Cannot add more of this product. Maximum stock reached.');
                        } else {
                            cart[index].quantity = newQuantity;
                        }
                        
                        // Force immediate UI update to reflect the new price
                        updateCartUI();
                        
                        // Update the payment modal totals if it's open
                        if (paymentModal._isShown) {
                            paymentItemsCount.textContent = cart.reduce((total, item) => total + item.quantity, 0);
                            paymentSubtotal.textContent = `${currency}${calculateSubtotal().toFixed(2)}`;
                            paymentTax.textContent = `${currency}${calculateTax().toFixed(2)}`;
                            paymentTotal.textContent = `${currency}${(calculateSubtotal() + calculateTax()).toFixed(2)}`;
                        }
                    });
                });
                
                document.querySelectorAll('.remove-item').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        cart.splice(index, 1);
                        updateCartUI();
                    });
                });
                
                checkoutButton.disabled = false;
            }
            
            // Update totals
            const subtotal = calculateSubtotal();
            const tax = calculateTax();
            const total = subtotal + tax;
            
            subtotalElement.textContent = `${currency}${subtotal.toFixed(2)}`;
            taxElement.textContent = `${currency}${tax.toFixed(2)}`;
            totalElement.textContent = `${currency}${total.toFixed(2)}`;
        }
        
        // Helper function to calculate subtotal
        function calculateSubtotal() {
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        }
        
        // Helper function to calculate tax
        function calculateTax() {
            // 10% tax rate for now, can be adjusted as needed
            return calculateSubtotal() * 0.1;
        }
        
        // Initialize cart UI
        updateCartUI();
    });
</script>
{% endblock %}
